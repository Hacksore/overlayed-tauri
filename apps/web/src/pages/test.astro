---
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <main class="main-content prose prose-invert px-8 pt-28">
    <div>
      <h1>Overlayed Connection Test</h1>

      <h3>Overlayed</h3>
      <div id="overlayed">⌛ Connecting to Discord...</div>

      <div id="streamkit-wrapper" class="hidden">
        <h3>Streamkit</h3>
        <div id="streamkit">connecting...</div>
      </div>

      <pre id="socket-log"></pre>
    </div>
  </main>

  <style>
    /* TODO: move this to a shared layout?*/
    .main-content {
      margin: auto;
      width: 800px;
      max-width: calc(100% - 2rem);
    }
  </style>

  <script>
    let connnected = false;
    const overlayedDiv = document.getElementById("overlayed")!;
    const socketLog = document.getElementById("socket-log")!;
    const streamkitWrapperDiv = document.getElementById("streamkit-wrapper")!;
    const streamkitDiv = document.getElementById("streamkit")!;

    function connectToDiscord(
      label: string,
      url: string,
      domNode: HTMLElement,
    ) {
      const socket = new WebSocket(url);

      const timeoutId = setTimeout(() => {
        if (!connnected) {
          domNode.innerHTML = "❌ Failed to connect to Discord";
        }
      }, 20_000);

      socket.addEventListener("open", () => {
        console.log("Connected to ws server");
        domNode.innerHTML = "🌎 Connected to Discord";
        connnected = true;
      });

      socket.addEventListener("message", (event) => {
        const payload = JSON.parse(event.data);
        console.log(payload);

        socketLog.innerHTML =
          socketLog.innerHTML +
          `[${label}]\n` +
          JSON.stringify(payload, null, 2) +
          "\n";

        if (payload.evt === "READY") {
          domNode.innerHTML = "✅ Received Discord READY Event";
          clearTimeout(timeoutId);
        }
      });

      socket.addEventListener("close", (err) => {
        console.log("close server", err);
      });

      socket.addEventListener("error", (err) => {
        console.log("err", err);
      });
    }

    connectToDiscord(
      "overlayed",
      "ws://127.0.0.1:6463?v=1&encoding=json&client_id=905987126099836938",
      overlayedDiv,
    );

    console.log("window.location.origin", window.location.origin);
    if (window.location.origin === "http://localhost:3000") {
      streamkitWrapperDiv.classList.remove("hidden");
      connectToDiscord(
        "streamkit",
        "ws://127.0.0.1:6463?v=1&encoding=json&client_id=207646673902501888",
        streamkitDiv,
      );
    }
  </script>
</Layout>
